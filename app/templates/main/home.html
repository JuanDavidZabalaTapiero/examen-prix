{% extends "base.html" %}

<!-- MENSAJES FLASH -->
{% set flash_categories = {
'error_main_home': 'alert-danger',
'success_main_home': 'alert-success'
} %}

{% block title %}Home{% endblock %}

{% block body %}

{% include "headers/main_header.html" %}

<main class="container py-5">
    <div class="text-center mb-5">
        <h1 class="mb-4">Inicio</h1>
        <a href="{{ url_for('students.exam') }}" class="btn btn-primary btn-lg">
            Nuevo examen
        </a>
    </div>

    {% if students %}
    <table class="table table-striped table-hover table-bordered align-middle text-center">
        <thead class="table-dark">
            <tr>
                <th>Documento</th>
                <th>ID</th>
                <th>Alumno</th>
                <th>Categorías</th>
                {% for comp in competences %}
                <th>% {{ comp }}</th>
                {% endfor %}
                <th>% Promedio</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>{{ student.document }}</td>
                <td>{{ student.doc_number }}</td>
                <td>{{ student.name }}</td>
                <td>{{ student.categories | join(", ") }}</td>
                {% for comp in competences %}
                <td>
                    {% set pct = student.competence_percentages.get(comp) %}
                    {{ pct|round|int ~ ' %' if pct is not none else 'Sin respuestas' }}
                </td>
                {% endfor %}
                <td>
                    <span class="fw-bold">
                        {{ student.total_percentage|round|int }}%
                    </span>
                    <br>
                    {% if student.total_percentage|round|int > 80 %}
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle-fill"></i> Aprobó
                    </span>
                    {% else %}
                    <span class="badge bg-danger">
                        <i class="bi bi-x-circle-fill"></i> Reprobó
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}


    <div class="row g-4">
        {% for q in data %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-center">{{ q.question }}</h5>

                    {% if q.counts | sum > 0 %}
                    <canvas id="chart-{{ q.question_id }}"></canvas>
                    {% else %}
                    <p class="text-muted text-center">Aún no hay respuestas</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</main>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart.umd.js') }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const chartData = JSON.parse('{{ data | tojson | safe }}')

        chartData.forEach((q) => {
            const ctx = document.getElementById(`chart-${q.question_id}`)
            if (ctx) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: q.labels,
                        datasets: [{
                            data: q.counts,
                            backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#8AFF33']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                })
            }
        })
    })
</script>
{% endblock %}